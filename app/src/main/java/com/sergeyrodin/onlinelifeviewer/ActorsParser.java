package com.sergeyrodin.onlinelifeviewer;

import com.sergeyrodin.onlinelifeviewer.utilities.Html;
import com.sergeyrodin.onlinelifeviewer.utilities.NetworkUtils;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URL;
import java.net.URLDecoder;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

class ActorsParser {

    ActorsData parse(BufferedReader in, String link) throws IOException{
        ActorsData result = new ActorsData();
        boolean spanFound = false;
        boolean isDirector = false;
        boolean infoDataFound = false;
        boolean countryFound = false;

        String line;
        while((line = in.readLine()) != null){
            if(line.contains("Режиссеры") && !spanFound) {
                spanFound = true;
                isDirector = true;
                continue;
            }
            if(line.contains("В ролях") && !spanFound) {
                spanFound = true;
                continue;
            }
            if(spanFound && !line.contains("span")) {
                result.setActors(parseAnchors(line, isDirector));
            }
            if(line.contains("</span>") && spanFound) {
                spanFound = false;
                isDirector = false;
            }

            if(line.contains("info_data")) {
                if(line.contains("</span>")) {
                    if(line.contains("<li>")) {
                        result.setYear(parseYear(line));
                    }
                }else {
                    infoDataFound = true;
                }
                continue;
            }

            if(line.contains("</span>") && infoDataFound) {
                infoDataFound = false;
            }

            if(infoDataFound) {
                if(!line.contains("<")) {
                    if(!countryFound) {
                        result.setCountry(line.trim());
                        countryFound = true;
                    }
                }
            }

            if(line.contains("<iframe")) {
                String iframeLink = parseIframe(line);
                if(iframeLink != null) {
                    String playerCode = loadPlayerCode(iframeLink, link);
                    String playerLink = parsePlayerCode(playerCode);
                    result.setPlayerLink(playerLink);
                }
                return result;
            }
        }
        return result;
    }

    private List<Actor> parseAnchors(String line, boolean isDirector) {
        List<Actor> actors = new ArrayList<>();
        Matcher m = Pattern.compile("<a\\s+href=\"(.+?)\">(.+?)</a>").matcher(line);
        while(m.find()) {
            actors.add(new Actor(Html.unescape(m.group(2)), isDirector, m.group(1)));
        }
        return actors;
    }

    private String parseIframe(String line) {
        int linkBegin = line.indexOf("src=");
        int linkEnd = line.indexOf("\"", linkBegin+6);
        if(linkBegin != -1 && linkEnd != -1) {
            return line.substring(linkBegin+5, linkEnd);
        }
        return null;
    }

    private String parseYear(String line) {
        int yearBegin = line.indexOf("\">");
        int yearEnd = line.indexOf("<", yearBegin);
        if(yearBegin != -1 && yearEnd != -1) {
            return line.substring(yearBegin+2, yearEnd);
        }
        return null;
    }

    private String parsePlayerCode(String code) throws UnsupportedEncodingException {
        int begin = code.indexOf("ref_url:");
        int end = code.indexOf("\"", begin+20);
        if(begin != -1 && end != -1) {
            String encodedUrl = code.substring(begin+10, end);
            return URLDecoder.decode(encodedUrl, "UTF-8");
        }
        return null;
    }

    private String loadPlayerCode(String iframeLink, String referer) throws IOException {
        URL url = new URL(iframeLink);
        return NetworkUtils.getResponseFromHttpUrl(url, referer);
    }
}
